<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lyrics Visualizer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: #000; color: #fff; height: 100vh; overflow: hidden;
    }

    .container { display: flex; height: 100vh; position: relative; }
    .dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3; transition: all 1s ease; overflow: hidden; }
    .gradient-overlay { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: #000; background-size: 400% 400%; animation: gradientFlow 15s ease infinite; opacity: 0.8; }
    @keyframes gradientFlow { 0% { transform: rotate(0deg) scale(1.2); background-position: 0% 50%; } 50% { transform: rotate(180deg) scale(1.3); background-position: 100% 50%; } 100% { transform: rotate(360deg) scale(1.2); background-position: 0% 50%; } }

    .image-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; filter: blur(30px) brightness(0.45) saturate(1.4); opacity: 0.9; z-index: -2; transition: all 0.5s ease; }

    .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }

    .particle { position: absolute; background: rgba(255,255,255,0.6); animation: float 20s infinite linear; opacity: 0.6; mix-blend-mode: screen; box-shadow: 0 6px 20px rgba(255,255,255,0.12); }
    .particle.circle { border-radius: 50%; }
    .particle.square { border-radius: 8px; }
    .particle.triangle { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
    .particle.star { 
      background: transparent;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='white' d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
    }
    .particle.line { 
      height: 2px;
      border-radius: 1px;
    }

    @keyframes float { 
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 
      8% { opacity: 0.7; } 
      92% { opacity: 0.7; } 
      100% { transform: translateY(-120px) rotate(360deg); opacity: 0; } 
    }

    .image-side { flex: 0 0 36%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; position: relative; z-index: 1; }
    .album-art { width: 320px; height: 320px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.6); margin-bottom: 15px; position: relative; transition: all 0.3s ease; }
    .album-art:hover { transform: scale(1.03); box-shadow: 0 30px 60px rgba(0,0,0,0.7); }
    .album-art img { width: 100%; height: 100%; object-fit: cover; }
    .album-placeholder { width: 100%; height: 100%; background: linear-gradient(135deg, #333 0%, #000 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; }

    .song-title { font-size: 24px; font-weight: 600; text-align: center; color: rgba(255, 255, 255, 0.9); width: 100%; max-width: 320px; padding: 8px 12px; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .player-section { display:flex; flex-direction:column; align-items:center; width:100%; max-width:320px; margin-top:5px; }
    .time-display { display:flex; justify-content:space-between; width:100%; font-size:12px; color: rgba(255,255,255,0.7); margin-bottom:8px; }
    .progress-container { width:100%; height:4px; background: rgba(255,255,255,0.2); border-radius:2px; margin-bottom:20px; cursor:pointer; position:relative; }
    .progress-bar { height:100%; background:#ffffff; width:0%; border-radius:2px; transition: width 0.1s; position:relative; }
    .progress-bar::after { content:''; position:absolute; right:-6px; top:50%; transform:translateY(-50%); width:12px; height:12px; background:#fff; border-radius:50%; box-shadow:0 0 10px rgba(255,255,255,0.8); opacity:0; transition:opacity 0.2s; }
    .progress-container:hover .progress-bar::after { opacity:1; }

    .controls { display:flex; align-items:center; gap:15px; width:100%; justify-content:center; }
    .control-btn { background: rgba(255,255,255,0.1); border:none; width:44px; height:44px; border-radius:50%; color:white; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.2); }
    .control-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .control-btn:active { transform: scale(0.95); }
    #playBtn { background: rgba(255,255,255,0.9); color:#000; width:56px; height:56px; font-size:20px; }

    .lyrics-side { flex: 1; display:flex; flex-direction:column; padding:40px; position:relative; z-index:1; }
    .file-inputs { display:flex; gap:15px; margin-bottom:25px; }
    .file-input-group { flex:1; display:flex; flex-direction:column; gap:10px; }
    .file-input-label { font-size:14px; color: rgba(255,255,255,0.8); margin-bottom:5px; }
    .file-btn { background: rgba(255,255,255,0.15); border:none; padding:15px; border-radius:10px; color:white; cursor:pointer; font-size:14px; backdrop-filter: blur(15px); border:1px solid rgba(255,255,255,0.2); transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; gap:8px; }
    .file-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }

    .settings-btn { position:absolute; top:20px; right:20px; background: rgba(255,255,255,0.15); border:none; padding:12px; border-radius:8px; color:white; cursor:pointer; font-size:18px; backdrop-filter: blur(15px); border:1px solid rgba(255,255,255,0.2); z-index:2; transition: all 0.3s ease; }
    .fullscreen-mode .settings-btn { display: none !important; }

    .settings-panel { position:absolute; top:70px; right:20px; background: rgba(0,0,0,0.9); padding:20px; border-radius:12px; backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.15); z-index:10; min-width:320px; display:none; box-shadow:0 10px 30px rgba(0,0,0,0.5); max-height:70vh; overflow:auto; }
    .settings-panel.active { display:block; }
    .settings-title { font-size:16px; margin-bottom:15px; color: rgba(255,255,255,0.9); font-weight:600; }
    .settings-group { margin-bottom:12px; }
    .settings-label { font-size:13px; color: rgba(255,255,255,0.8); margin-bottom:8px; display:block; }
    .settings-input, .settings-select, .settings-range { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px; color:white; padding:8px; font-size:13px; width:100%; }
    .custom-colors { display:flex; gap:8px; margin-top:10px; }
    .color-input { flex:1; height:30px; border:none; border-radius:6px; cursor:pointer; }

    .lyrics-display-container { flex:1; overflow:hidden; position:relative; display:flex; align-items:center; justify-content:center; }
    .lyrics-wheel { width:100%; max-width:700px; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; position:relative; }

    .lyrics-line {
      font-size:28px;
      line-height:1.4;
      margin:8px 0;
      padding:12px 20px;
      text-align:center;
      transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      width:100%;
      font-weight:400;
      color: rgba(255,255,255,0.6);
      position:absolute;
      left:0;
      opacity:0;
      transform: translateY(40px) scale(0.95);
    }

    .lyrics-line.active {
      opacity:1;
      transform: translateY(0) scale(1);
      color:#fff;
      font-size:32px;
      font-weight:600;
    }

    .lyrics-line.prev {
      opacity:0.4;
      transform: translateY(-60px) scale(0.9);
      color: rgba(255,255,255,0.5);
    }

    .lyrics-line.next {
      opacity:0.4;
      transform: translateY(60px) scale(0.9);
      color: rgba(255,255,255,0.5);
    }

    .lyrics-line.far-prev {
      opacity:0.2;
      transform: translateY(-120px) scale(0.85);
      color: rgba(255,255,255,0.3);
    }

    .lyrics-line.far-next {
      opacity:0.2;
      transform: translateY(120px) scale(0.85);
      color: rgba(255,255,255,0.3);
    }

    .fullscreen-btn { position:absolute; top:20px; left:20px; background: rgba(255,255,255,0.15); border:none; padding:12px; border-radius:8px; color:white; cursor:pointer; font-size:18px; backdrop-filter: blur(15px); border:1px solid rgba(255,255,255,0.2); z-index:2; transition:all 0.3s ease; }
    .fullscreen-btn:hover { background: rgba(255,255,255,0.25); transform:scale(1.1); }

    .fullscreen-mode .file-inputs { opacity:0; pointer-events:none; transform: translateY(-20px); }
    .fullscreen-mode .image-side, .fullscreen-mode .lyrics-side { padding:60px; }
    .fullscreen-mode .album-art { width:400px; height:400px; }
    .fullscreen-mode .lyrics-line { font-size:36px; }
    .fullscreen-mode .lyrics-line.active { font-size:40px; }

    @media (max-width:900px) {
      .image-side { display:none; }
      .lyrics-side { flex:1; padding:20px; }
    }
  </style>
</head>
<body>
  <div class="dynamic-bg" id="dynamicBg"><div class="gradient-overlay" id="gradientOverlay"></div></div>
  <div class="image-overlay" id="imageOverlay"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div class="container" id="mainContainer">
    <button class="fullscreen-btn" id="fullscreenBtn">‚õ∂</button>
    <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>

    <div class="settings-panel" id="settingsPanel">
      <div class="settings-title">T…ônziml…ôm…ôl…ôr</div>

      <div class="settings-group"><label class="settings-label">Mahnƒ± Adƒ±</label><input type="text" class="settings-input" id="songTitleInput" placeholder="Mahnƒ± adƒ±nƒ± daxil edin" maxlength="50"></div>

      <div class="settings-group"><label class="settings-label">≈ûrift N√∂v√º</label><select class="settings-select" id="fontSelect">
        <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
        <option value="'Georgia', serif">Georgia</option>
        <option value="'Arial', sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
        <option value="'Courier New', monospace">Courier New</option>
        <option value="'Verdana', sans-serif">Verdana</option>
        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        <option value="'Gill Sans', sans-serif">Gill Sans</option>
        <option value="'Palatino', serif" selected>Palatino</option>
        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
        <option value="'Impact', sans-serif">Impact</option>
        <option value="'Lucida Sans', sans-serif">Lucida Sans</option>
      </select></div>

      <div class="settings-group"><label class="settings-label">S√∂zl…ôrin ≈ûrift √ñl√ß√ºs√º</label><select class="settings-select" id="sizeSelect"><option value="20">√áox Ki√ßik</option><option value="24">Ki√ßik</option><option value="28" selected>Normal</option><option value="32">B√∂y√ºk</option><option value="36">Daha B√∂y√ºk</option><option value="40">√áox B√∂y√ºk</option><option value="44">N…ôh…ông</option></select></div>

      <div class="settings-group"><label class="settings-label">Arxa Fon R…ôngl…ôri</label><div class="custom-colors"><input type="color" class="color-input" id="color1" value="#000000"><input type="color" class="color-input" id="color2" value="#000000"><input type="color" class="color-input" id="color3" value="#000000"></div><button class="file-btn" id="applyColors" style="margin-top:10px;padding:10px;">R…ôngl…ôri T…ôtbiq Et</button></div>

      <div class="settings-group"><label class="settings-label">Partikullar ‚Äî Forma</label><select class="settings-select" id="particleShape"><option value="circle">Dair…ô</option><option value="square">Kvadrat</option><option value="triangle">√ú√ßbucaq</option><option value="star">Ulduz</option><option value="line">X…ôtt</option></select></div>
      <div class="settings-group"><label class="settings-label">Partikullar ‚Äî Say</label><input type="range" id="particleCount" class="settings-range" min="5" max="150" value="40"></div>
      <div class="settings-group"><label class="settings-label">Partikullar ‚Äî √ñl√ß√º (orta)</label><input type="range" id="particleSize" class="settings-range" min="2" max="40" value="12"></div>

      <div class="settings-group"><label class="settings-label">Arxa ≈û…ôklin Blur (px)</label><input type="range" id="bgBlur" class="settings-range" min="0" max="80" value="30"></div>

      <div class="settings-group"><label class="settings-label">Sinxronizasiya Rejimi</label>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <button class="file-btn" id="startSync">Start Sync</button>
          <button class="file-btn" id="stopSync">Stop</button>
          <button class="file-btn" id="exportLrc">Export .lrc</button>
        </div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">Start etdikd…ôn sonra audio oynat v…ô space il…ô h…ôr s…ôtri i≈üar…ôl…ô ‚Äî avtomatik timestamp …ôlav…ô olunacaq.</div>
      </div>

    </div>

    <div class="image-side">
      <div class="album-art"><img id="albumImage" src="" alt="" style="display:none;"><div class="album-placeholder" id="albumPlaceholder">üñºÔ∏è Albom ≈û…ôkli</div></div>
      <div class="song-title" id="songTitleDisplay">Mahnƒ± Adƒ±</div>
      <div class="player-section">
        <div class="time-display"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
        <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
        <div class="controls"><button class="control-btn" id="prevBtn">‚èÆ</button><button class="control-btn" id="playBtn">‚ñ∂</button><button class="control-btn" id="nextBtn">‚è≠</button></div>
      </div>
    </div>

    <div class="lyrics-side">
      <div class="file-inputs">
        <div class="file-input-group"><div class="file-input-label">Audio Faylƒ±</div><label class="file-btn">üéµ Audio Y√ºkl…ô<input type="file" id="audioFile" accept="audio/*" style="display:none"></label></div>
        <div class="file-input-group"><div class="file-input-label">Albom ≈û…ôkli</div><label class="file-btn">üñºÔ∏è ≈û…ôkil Y√ºkl…ô<input type="file" id="imageFile" accept="image/*" style="display:none"></label></div>
        <div class="file-input-group"><div class="file-input-label">S√∂zl…ôr</div><label class="file-btn">üìù S√∂zl…ôri Y√ºkl…ô<input type="file" id="lyricsFile" accept=".txt,.lrc" style="display:none"></label></div>
      </div>

      <div class="lyrics-display-container" id="lyricsDisplay">
        <div class="lyrics-wheel" id="lyricsWheel">
          <div class="lyrics-line active">S√∂zl…ôri …ôlav…ô edin</div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer" style="display:none"></audio>

  <script>
    // Elementl…ôri se√ß
    const mainContainer = document.getElementById('mainContainer');
    const dynamicBg = document.getElementById('dynamicBg');
    const gradientOverlay = document.getElementById('gradientOverlay');
    const imageOverlay = document.getElementById('imageOverlay');
    const particlesContainer = document.getElementById('particlesContainer');
    const albumImage = document.getElementById('albumImage');
    const albumPlaceholder = document.getElementById('albumPlaceholder');
    const songTitleDisplay = document.getElementById('songTitleDisplay');
    const songTitleInput = document.getElementById('songTitleInput');
    const lyricsWheel = document.getElementById('lyricsWheel');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioFile = document.getElementById('audioFile');
    const imageFile = document.getElementById('imageFile');
    const lyricsFile = document.getElementById('lyricsFile');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const fontSelect = document.getElementById('fontSelect');
    const sizeSelect = document.getElementById('sizeSelect');
    const color1 = document.getElementById('color1');
    const color2 = document.getElementById('color2');
    const color3 = document.getElementById('color3');
    const applyColors = document.getElementById('applyColors');
    const particleShape = document.getElementById('particleShape');
    const particleCount = document.getElementById('particleCount');
    const particleSize = document.getElementById('particleSize');
    const bgBlur = document.getElementById('bgBlur');
    const startSyncBtn = document.getElementById('startSync');
    const stopSyncBtn = document.getElementById('stopSync');
    const exportLrcBtn = document.getElementById('exportLrc');

    // D…ôyi≈ü…ônl…ôr
    let lyricsData = [];
    let currentLineIndex = 0;
    let isPlaying = false;
    let isSeeking = false;
    let activeParticles = [];
    let syncActive = false;
    let syncIndex = 0;

    // Partikul yaratma
    function createParticles() {
      // K√∂hn…ô partikullarƒ± t…ômizl…ô
      particlesContainer.innerHTML = '';
      activeParticles = [];
      
      const count = parseInt(particleCount.value, 10) || 40;
      const baseSize = parseInt(particleSize.value, 10) || 12;
      const shape = particleShape.value || 'circle';

      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        particle.classList.add(shape);

        const variance = (Math.random() - 0.5) * baseSize * 0.8;
        const size = Math.max(2, Math.round(baseSize + variance));
        
        if (shape === 'line') {
          particle.style.width = `${size * 3}px`;
          particle.style.height = '2px';
        } else {
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
        }
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;

        const delay = Math.random() * 8;
        const duration = Math.random() * 12 + 10;
        particle.style.animationDelay = `${delay}s`;
        particle.style.animationDuration = `${duration}s`;

        const colors = [color1.value, color2.value, color3.value];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        if (shape !== 'star') {
          particle.style.background = color;
        }

        particlesContainer.appendChild(particle);
        activeParticles.push(particle);
      }
    }

    // Arxa plan r…ôngl…ôrini yenil…ô
    function updateBackgroundColors(c1, c2, c3) {
      gradientOverlay.style.background = `linear-gradient(45deg, ${c1}, ${c2}, ${c3}, ${c1}99, ${c2}99)`;
      gradientOverlay.style.backgroundSize = '400% 400%';
    }

    // Zamanƒ± formatla
    function formatTime(seconds) { 
      if (isNaN(seconds)) return "0:00"; 
      const mins = Math.floor(seconds/60); 
      const secs = Math.floor(seconds%60); 
      return `${mins}:${secs<10?'0':''}${secs}`; 
    }

    // S√∂zl…ôri parse et - YENƒ∞L∆èNƒ∞B
    function parseLyrics(text) {
      console.log("S√∂z faylƒ± i√ßeriƒüi:", text);
      
      const lines = text.split('\n');
      const parsed = [];
      let hasTimestamps = false;
      
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine === '') continue;

        // LRC formatƒ± √º√ß√ºn zaman etiketl…ôrini tap
        const timeMatches = trimmedLine.matchAll(/\[(\d+):(\d+)(?:\.(\d+))?\]/g);
        let lastTime = 0;
        let textPart = trimmedLine;
        
        for (const timeMatch of timeMatches) {
          hasTimestamps = true;
          const minutes = parseInt(timeMatch[1]);
          const seconds = parseInt(timeMatch[2]);
          const msStr = timeMatch[3] ? timeMatch[3] : null;
          let frac = 0;
          
          if (msStr) { 
            // Milisaniy…ôl…ôri d√ºzg√ºn hesabla
            if (msStr.length === 3) {
              frac = parseInt(msStr)/1000; // 3 r…ôq…ômli milisaniy…ô
            } else if (msStr.length === 2) {
              frac = parseInt(msStr)/100;  // 2 r…ôq…ômli y√ºzd…ô bir saniy…ô
            } else if (msStr.length === 1) {
              frac = parseInt(msStr)/10;   // 1 r…ôq…ômli onda bir saniy…ô
            }
          }
          
          lastTime = minutes * 60 + seconds + frac;
          textPart = textPart.replace(timeMatch[0], '').trim();
        }
        
        if (textPart !== '') {
          parsed.push({ time: lastTime, text: textPart });
        }
      }
      
      // Zaman etiketl…ôri yoxdursa, avtomatik t…ôyin et
      if (!hasTimestamps && parsed.length > 0) { 
        const defaultDuration = 180; 
        const interval = defaultDuration/parsed.length; 
        parsed.forEach((line,i) => line.time = i*interval); 
      }
      
      // Zaman etiketl…ôrin…ô g√∂r…ô sƒ±rala
      parsed.sort((a,b) => { 
        if (a.time === null) return 1; 
        if (b.time === null) return -1; 
        return a.time - b.time; 
      });
      
      console.log("Parse edilmi≈ü s√∂zl…ôr:", parsed);
      return parsed;
    }

    // S√∂z faylƒ±nƒ± y√ºkl…ô
    function loadLyricsFromFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) { 
        const text = e.target.result; 
        lyricsData = parseLyrics(text); 
        currentLineIndex = 0; 
        displayLyrics(); 
        updateFontSettings(); 
        
        // Audio y√ºkl√ºd√ºrs…ô v…ô zaman etiketl…ôri yoxdursa, avtomatik t…ôyin et
        if (audioPlayer.duration && lyricsData.length > 0 && lyricsData[0].time === null) { 
          const duration = audioPlayer.duration; 
          const interval = duration/lyricsData.length; 
          lyricsData.forEach((line,i) => line.time = i*interval); 
          displayLyrics();
        }
      };
      reader.onerror = function(e) {
        console.error("Fayl oxuma x…ôtasƒ±:", e);
        alert("S√∂z faylƒ± oxuna bilm…ôdi!");
      };
      reader.readAsText(file);
    }

    // S√∂zl…ôri g√∂st…ôr
    function displayLyrics() {
      lyricsWheel.innerHTML = '';
      
      if (lyricsData.length === 0) {
        const line = document.createElement('div'); 
        line.className = 'lyrics-line active'; 
        line.textContent = 'S√∂zl…ôri …ôlav…ô edin'; 
        lyricsWheel.appendChild(line); 
        return;
      }
      
      lyricsData.forEach((lineData, index) => {
        const line = document.createElement('div'); 
        line.className = 'lyrics-line'; 
        line.dataset.index = index;
        line.textContent = lineData.text;

        line.addEventListener('click', () => { 
          if (audioPlayer.src && lineData.time !== null) { 
            audioPlayer.currentTime = lineData.time; 
            currentLineIndex = index; 
            updateDisplay(); 
            if (!isPlaying) { 
              audioPlayer.play(); 
              isPlaying = true; 
              updatePlayButton(); 
            } 
          } 
        });

        line.style.fontFamily = fontSelect.value;
        line.style.fontSize = `${sizeSelect.value}px`;
        lyricsWheel.appendChild(line);
      });
      
      updateDisplay(); 
    }

    // G√∂r√ºn√º≈ü√º yenil…ô
    function updateDisplay() {
      const lines = document.querySelectorAll('.lyrics-line');
      
      if (lines.length === 0) return;
      
      lines.forEach((line, index) => {
        line.classList.remove('active', 'prev', 'next', 'far-prev', 'far-next');
        
        const diff = index - currentLineIndex;
        
        if (diff === 0) {
          line.classList.add('active');
        } else if (diff === -1) {
          line.classList.add('prev');
        } else if (diff === 1) {
          line.classList.add('next');
        } else if (diff === -2) {
          line.classList.add('far-prev');
        } else if (diff === 2) {
          line.classList.add('far-next');
        }
      });
    }

    // ≈ûrift ayarlarƒ±nƒ± yenil…ô
    function updateFontSettings() {
      const fontFamily = fontSelect.value; 
      const fontSize = sizeSelect.value;
      
      const lines = document.querySelectorAll('.lyrics-line');
      lines.forEach(line => { 
        line.style.fontFamily = fontFamily; 
        line.style.fontSize = `${fontSize}px`; 
      });
      
      const activeLines = document.querySelectorAll('.lyrics-line.active');
      activeLines.forEach(line => { 
        line.style.fontSize = `${parseInt(fontSize) + 4}px`; 
      });
    }

    // Ayarlar panelini a√ß/baƒüla
    function toggleSettingsPanel() { 
      settingsPanel.classList.toggle('active'); 
    }
    
    // Tam ekran rejimi
    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) { 
        document.documentElement.requestFullscreen().catch(err => console.log(`Fullscreen error: ${err.message}`)); 
        mainContainer.classList.add('fullscreen-mode'); 
      } else { 
        document.exitFullscreen(); 
        mainContainer.classList.remove('fullscreen-mode'); 
      }
    });
    
    // Audio faylƒ± y√ºkl…ô
    audioFile.addEventListener('change', (e) => { 
      const file = e.target.files[0]; 
      if (file) { 
        if (audioPlayer.src) URL.revokeObjectURL(audioPlayer.src); 
        audioPlayer.src = URL.createObjectURL(file); 
        if (songTitleDisplay.textContent === 'Mahnƒ± Adƒ±') { 
          const fileName = file.name.replace(/\.[^/.]+$/,''); 
          songTitleDisplay.textContent = fileName; 
          songTitleInput.value = fileName; 
        } 
        audioPlayer.addEventListener('loadedmetadata', () => { 
          durationDisplay.textContent = formatTime(audioPlayer.duration); 
          // Zaman etiketl…ôri yoxdursa, avtomatik t…ôyin et
          if (lyricsData.length > 0 && lyricsData[0].time === null) { 
            const duration = audioPlayer.duration; 
            const interval = duration/lyricsData.length; 
            lyricsData.forEach((line,i) => line.time = i*interval); 
            displayLyrics();
          } 
        }); 
      } 
    });

    // ≈û…ôkil faylƒ± y√ºkl…ô
    imageFile.addEventListener('change', (e) => { 
      const file = e.target.files[0]; 
      if (file) { 
        const url = URL.createObjectURL(file); 
        albumImage.src = url; 
        albumImage.style.display = 'block'; 
        albumPlaceholder.style.display = 'none'; 
        imageOverlay.style.backgroundImage = `url(${url})`; 
      } 
    });

    // S√∂z faylƒ± y√ºkl…ô
    lyricsFile.addEventListener('change', (e) => { 
      const file = e.target.files[0]; 
      if (file) {
        console.log("S√∂z faylƒ± se√ßildi:", file.name);
        loadLyricsFromFile(file); 
      }
    });

    // Play/Pause d√ºym…ôsi
    function updatePlayButton() { 
      playBtn.textContent = isPlaying ? '‚è∏' : '‚ñ∂'; 
    }
    
    playBtn.addEventListener('click', () => {
      if (!audioPlayer.src) { 
        alert('∆èvv…ôlc…ô audio faylƒ± y√ºkl…ôyin!'); 
        return; 
      }
      if (isPlaying) { 
        audioPlayer.pause(); 
        isPlaying = false; 
      } else { 
        audioPlayer.play(); 
        isPlaying = true; 
      }
      updatePlayButton();
    });

    // N√∂vb…ôti/∆èvv…ôlki d√ºym…ôl…ôri
    prevBtn.addEventListener('click', () => { 
      if (currentLineIndex > 0) { 
        currentLineIndex--; 
        if (audioPlayer.src && lyricsData[currentLineIndex]?.time !== null) 
          audioPlayer.currentTime = Math.max(0, lyricsData[currentLineIndex].time - 0.1); 
        updateDisplay(); 
      } 
    });
    
    nextBtn.addEventListener('click', () => { 
      if (currentLineIndex < lyricsData.length - 1) { 
        currentLineIndex++; 
        if (audioPlayer.src && lyricsData[currentLineIndex]?.time !== null) 
          audioPlayer.currentTime = lyricsData[currentLineIndex].time; 
        updateDisplay(); 
      } 
    });

    // Ayarlar paneli
    settingsBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      toggleSettingsPanel(); 
    });
    
    document.addEventListener('click', (e) => { 
      if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) 
        settingsPanel.classList.remove('active'); 
    });

    // Proqress bar
    progressContainer.addEventListener('click', (e) => { 
      if (!audioPlayer.src) return; 
      const rect = progressContainer.getBoundingClientRect(); 
      const percent = (e.clientX - rect.left)/rect.width; 
      audioPlayer.currentTime = percent * audioPlayer.duration; 
    });
    
    progressContainer.addEventListener('mousedown', () => { 
      isSeeking = true; 
    });
    
    document.addEventListener('mouseup', () => { 
      isSeeking = false; 
    });
    
    progressContainer.addEventListener('mousemove', (e) => { 
      if (isSeeking) { 
        const rect = progressContainer.getBoundingClientRect(); 
        const percent = (e.clientX - rect.left)/rect.width; 
        audioPlayer.currentTime = percent * audioPlayer.duration; 
      } 
    });

    // Audio zaman yenil…ôm…ôsi - YENƒ∞L∆èNƒ∞B
    audioPlayer.addEventListener('timeupdate', () => {
      const currentTime = audioPlayer.currentTime;
      
      if (!isSeeking && audioPlayer.duration) { 
        const progress = (currentTime/audioPlayer.duration)*100; 
        progressBar.style.width = progress + '%'; 
      }
      
      currentTimeDisplay.textContent = formatTime(currentTime);
      
      if (syncActive) return;

      if (lyricsData.length === 0) return;

      let newIndex = currentLineIndex;
      
      // Cari zaman √º√ß√ºn uyƒüun s…ôtiri tap - daha d…ôqiq alqoritm
      for (let i = 0; i < lyricsData.length; i++) {
        if (lyricsData[i].time !== null && lyricsData[i].time <= currentTime + 0.3) {
          newIndex = i;
        } else {
          break;
        }
      }
      
      if (newIndex !== currentLineIndex) { 
        currentLineIndex = newIndex; 
        updateDisplay(); 
      }
    });

    // Klaviatura idar…ôsi
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        if (syncActive) {
          if (lyricsData[syncIndex]) {
            lyricsData[syncIndex].time = audioPlayer.currentTime;
            syncIndex++;
            currentLineIndex = Math.min(syncIndex, lyricsData.length-1);
            updateDisplay();
          }
          return;
        }
        if (isPlaying) { 
          audioPlayer.pause(); 
          isPlaying = false; 
        } else { 
          audioPlayer.play(); 
          isPlaying = true; 
        } 
        updatePlayButton();
      } else if (e.key === 'ArrowLeft') prevBtn.click(); 
      else if (e.key === 'ArrowRight') nextBtn.click(); 
      else if (e.key.toLowerCase() === 'f') fullscreenBtn.click();
    });

    // Sinxronizasiya - YENƒ∞L∆èNƒ∞B
    startSyncBtn.addEventListener('click', () => {
      if (lyricsData.length === 0) { 
        alert('∆èvv…ôlc…ô s√∂z faylƒ± y√ºkl…ôyin.'); 
        return; 
      }
      if (!audioPlayer.src) { 
        alert('∆èvv…ôlc…ô audio faylƒ± y√ºkl…ôyin.'); 
        return; 
      }
      syncActive = true; 
      syncIndex = 0; 
      currentLineIndex = 0; 
      updateDisplay(); 
      if (!isPlaying) { 
        audioPlayer.currentTime = 0; 
        audioPlayer.play(); 
        isPlaying = true; 
        updatePlayButton(); 
      }
      startSyncBtn.textContent = 'Sync aktiv'; 
      startSyncBtn.style.opacity = '0.7';
    });

    stopSyncBtn.addEventListener('click', () => {
      syncActive = false; 
      startSyncBtn.textContent = 'Start Sync'; 
      startSyncBtn.style.opacity = '1'; 
      alert('Sinxronizasiya dayandƒ±rƒ±ldƒ±. ƒ∞st…ôs…ôn Export .lrc il…ô ixrac et.');
    });

    // Export LRC - YENƒ∞L∆èNƒ∞B
    exportLrcBtn.addEventListener('click', () => {
      if (lyricsData.length === 0) { 
        alert('S√∂z yoxdur.'); 
        return; 
      }
      
      // Daha d…ôqiq timestamp formatƒ±
      function formatTimestampForLrc(time) {
        const mins = Math.floor(time / 60);
        const secs = Math.floor(time % 60);
        // Milisaniy…ôl…ôri 2 r…ôq…ômli formatda g√∂st…ôr (y√ºzd…ô bir saniy…ô)
        const cents = Math.floor((time - Math.floor(time)) * 100);
        return `[${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(cents).padStart(2, '0')}]`;
      }
      
      let lines = [];
      for (const ln of lyricsData) {
        const t = ln.time != null ? formatTimestampForLrc(ln.time) : '[00:00.00]';
        lines.push(`${t}${ln.text}`);
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = (songTitleInput.value || 'lyrics') + '.lrc'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
    });

    // Event listener-lar
    songTitleInput.addEventListener('input', () => { 
      const newTitle = songTitleInput.value.trim(); 
      if (newTitle) songTitleDisplay.textContent = newTitle; 
    });
    
    applyColors.addEventListener('click', () => { 
      updateBackgroundColors(color1.value, color2.value, color3.value); 
      createParticles(); 
    });

    particleShape.addEventListener('change', createParticles);
    particleCount.addEventListener('input', createParticles);
    particleSize.addEventListener('input', createParticles);

    bgBlur.addEventListener('input', () => { 
      const val = parseInt(bgBlur.value,10); 
      imageOverlay.style.filter = `blur(${val}px) brightness(0.45) saturate(1.4)`; 
    });

    fontSelect.addEventListener('change', updateFontSettings);
    sizeSelect.addEventListener('change', updateFontSettings);

    // T…ôtilm…ô
    function initializeApp() { 
      updateBackgroundColors('#000000','#000000','#000000'); 
      displayLyrics(); 
      updateFontSettings(); 
      createParticles(); 
      imageOverlay.style.filter = `blur(${parseInt(bgBlur.value,10)}px) brightness(0.45) saturate(1.4)`; 
    }
    
    initializeApp();

    window.addEventListener('resize', () => { 
      // Yenid…ôn konteynerin √∂l√ß√ºl…ôrini hesabla
      updateDisplay();
    });
  </script>
</body>
</html>
